{{ define "title" }}{{ .Site.Title }} - –õ—É—á—à–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏{{ end }}

{{ define "main" }}

<!-- Hero Section with Search -->
<section class="hero-section py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <!-- Hero Title -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-white mb-3">
                        –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                    </h1>
                    <p class="lead text-white-50 mb-4">
                        –ë–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ —á–µ—Å—Ç–Ω—ã–º —Ü–µ–Ω–∞–º
                    </p>
                </div>

                <!-- Search Form -->
                <div class="search-card p-4 p-lg-5 rounded-4 shadow-lg bg-white">
                    <form action="{{ "cars/" | relURL }}" method="GET" class="car-search-form">
                        <div class="row g-3">
                            <!-- –ú–∞—Ä–∫–∞ -->
                            <div class="col-md-5">
                                <div class="form-floating">
                                    <select class="form-select" id="brand" name="brand">
                                        <option value="" selected disabled hidden></option>
                                        {{ range .Site.Taxonomies.brands }}
                                        <option value="{{ .Page.Title }}">{{ .Page.Title }}</option>
                                        {{ end }}
                                    </select>
                                    <label for="brand">–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</label>
                                </div>
                            </div>

                            <!-- –ú–æ–¥–µ–ª—å -->
                            <div class="col-md-5">
                                <div class="form-floating">
                                    <select class="form-select" id="model" name="model" disabled>
                                        <option value="" selected disabled hidden></option>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É</option>
                                    </select>
                                    <label for="model">–ú–æ–¥–µ–ª—å</label>
                                </div>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100 h-100 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-search me-2"></i>
                                    <span class="d-none d-md-inline">–ü–æ–∏—Å–∫</span>
                                </button>
                            </div>
                        </div>

                        <!-- Advanced Filters Toggle -->
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                <i class="fas fa-filter me-2"></i>
                                –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="collapse mt-4" id="advancedFilters">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="year_from" name="year_from" placeholder="2000">
                                        <label for="year_from">–ì–æ–¥ –æ—Ç</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="year_to" name="year_to" placeholder="2024">
                                        <label for="year_to">–ì–æ–¥ –¥–æ</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control price-input" id="price_from" name="price_from" placeholder="500 000">
                                        <label for="price_from">–¶–µ–Ω–∞ –æ—Ç, ‚ÇΩ</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control price-input" id="price_to" name="price_to" placeholder="3 000 000">
                                        <label for="price_to">–¶–µ–Ω–∞ –¥–æ, ‚ÇΩ</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Cars -->
<section class="featured-cars py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="display-5 fw-bold mb-3">–ù–∞—à–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</h2>
                <p class="lead text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–∑ –Ω–∞—à–µ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞</p>
            </div>
        </div>

        <!-- Car Grid -->
        <div class="row g-4">
            {{ range first .Site.Params.featured_cars_count (where .Site.RegularPages "Section" "cars") }}
            <div class="col-lg-4 col-md-6">
                {{ partial "car-card.html" . }}
            </div>
            {{ end }}
        </div>

        <!-- View All Button -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <a href="{{ "cars/" | relURL }}" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-cars me-2"></i>
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ ({{ len (where .Site.RegularPages "Section" "cars") }})
                </a>
            </div>
        </div>
    </div>
</section>

<script>
        // Price Formatting with Thousand Separators
        document.addEventListener('DOMContentLoaded', function() {
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
            const priceInputs = document.querySelectorAll('.price-input');

            priceInputs.forEach(input => {
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, ''); // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã

                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                    value = value.replace(/\D/g, '');

                    if (value) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ç—ã—Å—è—á
                        e.target.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    }
                });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
                input.closest('form').addEventListener('submit', function() {
                    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å —á–∏—Å–ª–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    const numericValue = input.value.replace(/\s/g, '');
                    input.setAttribute('data-numeric-value', numericValue);
                });
            });

            console.log('Price formatting initialized');
        });

        // Dynamic Brand/Model Selector
        document.addEventListener('DOMContentLoaded', function() {
            const brandSelect = document.getElementById('brand');
            const modelSelect = document.getElementById('model');

    let modelsData = {};

    if (!brandSelect || !modelSelect) {
        console.error('Select elements not found!', {brandSelect, modelSelect});
        return;
    }

    console.log('Initializing brand/model selectors...');

    // Load models data
    fetch('{{ "cars/models-data.json" | relURL }}')
        .then(response => {
            console.log('Fetching models data...');
            return response.json();
        })
        .then(data => {
            console.log('Models data loaded:', Object.keys(data).length, 'brands');
            modelsData = data;
            populateBrands();
        })
        .catch(error => {
            console.error('Error loading models data:', error);
            // Fallback: just enable the selects
            if (brandSelect) brandSelect.disabled = false;
        });

    function populateBrands() {
        if (!brandSelect || !modelsData) return;

        // Clear existing options except first
        brandSelect.innerHTML = '<option value="" selected disabled hidden></option>';

        // Add brands
        const brands = Object.keys(modelsData).sort();
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            brandSelect.appendChild(option);
        });

        brandSelect.disabled = false;
    }

    // Brand selection handler
    if (brandSelect) {
        brandSelect.addEventListener('change', function() {
            const selectedBrand = this.value;
            console.log('=== Brand Selection Event ===');
            console.log('Selected brand:', selectedBrand);
            console.log('Brand type:', typeof selectedBrand);
            console.log('Available models:', modelsData[selectedBrand]);
            console.log('Models type:', typeof modelsData[selectedBrand]);
            console.log('Models is Array:', Array.isArray(modelsData[selectedBrand]));

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
            console.log('Check 1 - selectedBrand:', !!selectedBrand);
            console.log('Check 2 - modelsData[selectedBrand]:', !!modelsData[selectedBrand]);
            console.log('Check 3 - modelSelect exists:', !!modelSelect);

            if (!selectedBrand || !modelsData[selectedBrand]) {
                console.log('‚ùå Validation failed - returning');
                modelSelect.disabled = true;
                modelSelect.setAttribute('disabled', 'disabled');
                modelSelect.innerHTML = '<option value="" selected disabled hidden></option><option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É</option>';
                return;
            }

            console.log('‚úÖ Validation passed - proceeding to populate models');

            // Populate models
            const models = modelsData[selectedBrand];
            console.log('Models to add:', models.length);

            // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
            modelSelect.innerHTML = '';
            console.log('Cleared model select');

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é
            const firstOption = document.createElement('option');
            firstOption.value = '';
            firstOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å';
            modelSelect.appendChild(firstOption);
            console.log('Added first option');

            if (models && models.length > 0) {
                console.log('Starting to add', models.length, 'models...');
                models.forEach((model, index) => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                    if (index < 3) {
                        console.log(`Added model ${index}:`, model);
                    }
                });

                // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –≤–∫–ª—é—á–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä - –∏ —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–æ, –∏ —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç
                modelSelect.disabled = false;
                modelSelect.removeAttribute('disabled');

                console.log('‚úÖ Model select enabled, total options:', modelSelect.options.length);
                console.log('Disabled property:', modelSelect.disabled);

                // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
                [50, 100, 200, 500].forEach(delay => {
                    setTimeout(() => {
                        const currentOptionsCount = modelSelect.options.length;
                        if (modelSelect.disabled || modelSelect.hasAttribute('disabled') || currentOptionsCount < 2) {
                            console.error(`‚ö†Ô∏è After ${delay}ms - fixing selector! disabled:`, modelSelect.disabled, 'options:', currentOptionsCount);

                            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
                            modelSelect.disabled = false;
                            modelSelect.removeAttribute('disabled');

                            // –ï—Å–ª–∏ –æ–ø—Ü–∏–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
                            if (currentOptionsCount < 2) {
                                modelSelect.innerHTML = '';
                                const firstOption = document.createElement('option');
                                firstOption.value = '';
                                firstOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å';
                                modelSelect.appendChild(firstOption);

                                models.forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model;
                                    option.textContent = model;
                                    modelSelect.appendChild(option);
                                });
                                console.log(`Restored ${models.length} models`);
                            }
                        }
                    }, delay);
                });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                            if (modelSelect.disabled && models.length > 0) {
                                console.error('üö® MutationObserver: Someone tried to disable model select! Re-enabling...');
                                modelSelect.disabled = false;
                                modelSelect.removeAttribute('disabled');
                            }
                        }
                    });
                });

                observer.observe(modelSelect, {
                    attributes: true,
                    attributeFilter: ['disabled']
                });

                console.log('üëÅÔ∏è MutationObserver —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–µ–ª–µ–∫—Ç–æ—Ä–∞');
            } else {
                console.log('‚ùå No models found for brand');
                modelSelect.innerHTML = '<option value="">–ù–µ—Ç –º–æ–¥–µ–ª–µ–π</option>';
                modelSelect.disabled = true;
            }
        });
    } else {
        console.error('Brand select element not found');
    }
});
</script>

{{ end }}